"use strict";(self.webpackChunkspm_kubernetes=self.webpackChunkspm_kubernetes||[]).push([[4495],{2479:function(e,a,n){n.r(a),n.d(a,{_frontmatter:function(){return i},default:function(){return f}});var s=n(45),t=(n(6540),n(5680)),r=n(4330);const o=["components"],i={},p=e=>function(a){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,t.yg)("div",a)},l=p("Caption"),c=p("InlineNotification"),m=p("Tabs"),u=p("Tab"),d=p("Row"),g=p("Column"),h={_frontmatter:i},y=r.A;function f(e){let{components:a}=e,n=(0,s.A)(e,o);return(0,t.yg)(y,Object.assign({},h,n,{components:a,mdxType:"MDXLayout"}),(0,t.yg)("h2",null,"How batch streaming is deployed in Kubernetes"),(0,t.yg)("p",null,"Merative Social Program Management (SPM) on Kubernetes supports a different model for batch processing in AKS, where, as outlined earlier, SPM batch processing can be built and deployed into its own pod.\nBy running SPM batch processing in its own pod, the pod can leverage the benefits of flexibility, elasticity, efficiency and the strategic value offered by cloud native architecture."),(0,t.yg)("h3",null,"What is batch streaming?"),(0,t.yg)("p",null,"The batch streaming infrastructure provides a straightforward mechanism to implement a batch process so that it can be run in parallel (streams) across multiple pods.\nFor example, if we wanted to issue payments, the chunker identifies all the cases to be paid and the stream would process a case and issue the payments that are due."),(0,t.yg)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"702px"}},"\n      ",(0,t.yg)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"54.513888888888886%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB4ElEQVQoz12SW2/TQBCF/d/5FUgQHpD6VhoQSKAi2gqJAm2a5mJ713acyPZeEpL4tmt712sv2qStCqPzOJ/mnJmxZnHjIGmUVB5iHip9VMKkCDBbEB5gFmAWUu4h5iTCRdI1zeKIWC6WHlUe7SDigy/F6SWG7nRuz6uKa90nO3HhVKxp87Ky49qjLcDSI61HW48qy0UGdnELk2LkNyFp+65VSvV9r7W2V9nJFcmY2OfsPsztuHZiaUeNTzufagtgudh0DhKzZaaf1YHV26zy472QqqyMYbguJ1F0NZldA+CQjTVeiWmsAKrmC6rFbhJmH8b1NMxGcC2VVq1M9zut+4ILJ5EORefXn4afzz5+HY6Wd9a7GzYc1bMou/MT3bELu3jxvvhhby5vF43sVaeZMC4eYXx6dvLm5au3g8FP8Nu6XZrJLqqn4U5rzZsuZYqLngnjG6D69bddSGtem/WCdXG/Wn0fz345wMbUgsRkdpGcL9N/Mxs4SLLzEZkE2zRn4zC3o8ZN2nnU+OsuWGtzKp8qSJQbs74zyFHdYWFpKaZhird1wRs7qiBpARaQyMOp2oc7Q9rBhB+nPa+mqSlBWuvcZDYDD0/xoKcnUQDVaMPQH/6f8LbCW74iDDx2PsF/AT7iV6TQTyIMAAAAAElFTkSuQmCC')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,t.yg)("picture",{parentName:"span"},"\n          ",(0,t.yg)("source",{parentName:"picture",srcSet:["/spm-kubernetes/static/2d95d0591a546fe9893ff6179ac54d2d/0eda2/spm_batch_processing_on_kubernetes.webp 288w","/spm-kubernetes/static/2d95d0591a546fe9893ff6179ac54d2d/460e2/spm_batch_processing_on_kubernetes.webp 576w","/spm-kubernetes/static/2d95d0591a546fe9893ff6179ac54d2d/6a980/spm_batch_processing_on_kubernetes.webp 702w"],sizes:"(max-width: 702px) 100vw, 702px",type:"image/webp"}),"\n          ",(0,t.yg)("source",{parentName:"picture",srcSet:["/spm-kubernetes/static/2d95d0591a546fe9893ff6179ac54d2d/7fc1e/spm_batch_processing_on_kubernetes.png 288w","/spm-kubernetes/static/2d95d0591a546fe9893ff6179ac54d2d/a5df1/spm_batch_processing_on_kubernetes.png 576w","/spm-kubernetes/static/2d95d0591a546fe9893ff6179ac54d2d/254b8/spm_batch_processing_on_kubernetes.png 702w"],sizes:"(max-width: 702px) 100vw, 702px",type:"image/png"}),"\n          ",(0,t.yg)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/spm-kubernetes/static/2d95d0591a546fe9893ff6179ac54d2d/254b8/spm_batch_processing_on_kubernetes.png",alt:"spm batch on kubernetes",title:"spm batch on kubernetes",loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"}}),"\n        "),"\n    "),(0,t.yg)(l,{mdxType:"Caption"},(0,t.yg)("p",null,(0,t.yg)("em",{parentName:"p"},"Figure 1:")," SPM batch processing on kubernetes")),(0,t.yg)("p",null,"For more information about batch streaming architecture, see ",(0,t.yg)("strong",{parentName:"p"},"Batch Streaming Architecture")," in the ",(0,t.yg)("em",{parentName:"p"},"Social Program Management CÃºram Batch Performance Mechanisms"),"."),(0,t.yg)(c,{mdxType:"InlineNotification"},(0,t.yg)("p",null,"The Social Program Management PDF documentation is available to download from ",(0,t.yg)("a",{parentName:"p",href:"https://curam-spm-devops.github.io/wh-support-docs/spm/pdf-documentation/"},"Merative Support Docs"),".")),(0,t.yg)("h2",null,"Setting up Batch Streaming with Helm"),(0,t.yg)("p",null,"Streamed jobs may be scheduled using Helm the same way as standalone Batch jobs."),(0,t.yg)("p",null,"In your override values file, add a section under the ",(0,t.yg)("inlineCode",{parentName:"p"},"batch.streamed")," key for each of the streamed jobs to be scheduled."),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},'batch:\n  streamed:\n    cash_reassessment:\n      schedule: "0 1 * * *"\n      chunker:\n        className: curam.core.sl.infrastructure.assessment.intf.CREOLEBulkCaseChunkReassessmentByProduct.process\n        parameters: productID=4100\n        replicaCount: 1\n      stream:\n        className: curam.core.sl.infrastructure.assessment.intf.CREOLEBulkCaseChunkReassessmentStream.process\n        replicaCount: 1\n    food_reassessment:\n      schedule: "0 2 * * */2"\n      chunker:\n        className: curam.core.sl.infrastructure.assessment.intf.CREOLEBulkCaseChunkReassessmentByProduct.process\n        parameters: productID=4200\n        replicaCount: 1\n      stream:\n        className: curam.core.sl.infrastructure.assessment.intf.CREOLEBulkCaseChunkReassessmentStream.process\n        replicaCount: 1\n')),(0,t.yg)("p",null,"This example schedules Cash Assistance bulk reassessment to run at 1 AM every night, and Food Assistance bulk reassessment to run at 2 AM every second night."),(0,t.yg)("p",null,"The ",(0,t.yg)("inlineCode",{parentName:"p"},"cash_reassessment")," and ",(0,t.yg)("inlineCode",{parentName:"p"},"food_reassessment")," keys have no special meaning - their purpose is to provide separate definitions of different batch jobs.\nThese keys are used in names of the CronJob objects, e.g. ",(0,t.yg)("inlineCode",{parentName:"p"},"<releaseName>-batch-food-reassessment-chunker")," and ",(0,t.yg)("inlineCode",{parentName:"p"},"<releaseName>-batch-food-reassessment-stream")),(0,t.yg)("p",null,"A complete list of configurable options for the chunkers and streams is available on the Helm ",(0,t.yg)("a",{parentName:"p",href:"/spm-kubernetes/deployment/config-reference#batch-jobs"},"Configuration Reference")," page."),(0,t.yg)("h2",null,"Ad-hoc execution of Batch Streaming jobs"),(0,t.yg)("p",null,"An example for the steps required to set up Batch Streaming is outlined as follows.\nThis example uses the bulk reassessment of food assistance case types."),(0,t.yg)("p",null,"The first stage is to set up a new YAML file for the streaming and chunking batch processing."),(0,t.yg)(c,{mdxType:"InlineNotification"},(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"Note:")," No SPM default installation settings were changed.")),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl create job --from=cronjob/${release_name}-batch-queued \\\n       -n $namespace -o yaml --dry-run=client process_name > process_name.yaml\n")),(0,t.yg)("p",null,"Where:"),(0,t.yg)("ul",null,(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("inlineCode",{parentName:"li"},"namespace")," is the namespace where you want to run the batch processing"),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("inlineCode",{parentName:"li"},"release_name")," is the name of the release you are using"),(0,t.yg)("li",{parentName:"ul"},(0,t.yg)("inlineCode",{parentName:"li"},"process_name")," is the name of the batch process you are creating")),(0,t.yg)("p",null,"You should also create a new file for each process, for example ",(0,t.yg)("inlineCode",{parentName:"p"},"stream_foodassistance.yaml"),", and ",(0,t.yg)("inlineCode",{parentName:"p"},"chunker_foodassistance.yaml")),(0,t.yg)("p",null,"A corresponding YAML file is created. Open it with your preferred editor and add the following lines to the ",(0,t.yg)("inlineCode",{parentName:"p"},"spec.template.spec.containers[0]")," section:"),(0,t.yg)(m,{mdxType:"Tabs"},(0,t.yg)(u,{label:"Chunker",mdxType:"Tab"},(0,t.yg)(d,{mdxType:"Row"},(0,t.yg)(g,{mdxType:"Column"},(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},'args:\n- -Dbatch.program=curam.core.sl.infrastructure.assessment.intf.CREOLEBulkCaseChunkReassessmentByProduct.process\n- -Dbatch.parameters="productID=4200"\n')),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"Note:")," The ",(0,t.yg)("inlineCode",{parentName:"p"},"args")," key should become a sibling of the ",(0,t.yg)("inlineCode",{parentName:"p"},"command")," key.")))),(0,t.yg)(u,{label:"Stream",mdxType:"Tab"},(0,t.yg)(d,{mdxType:"Row"},(0,t.yg)(g,{mdxType:"Column"},(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-yaml"},"args:\n- -Dbatch.program=curam.core.sl.infrastructure.assessment.intf.CREOLEBulkCaseChunkReassessmentStream.process\n")),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"Note:")," The ",(0,t.yg)("inlineCode",{parentName:"p"},"args")," key should become a sibling of the ",(0,t.yg)("inlineCode",{parentName:"p"},"command")," key."))))),(0,t.yg)("p",null,"You should now have YAML files for a chunker and streamer for bulk reassessment of food assistance case types."),(0,t.yg)(c,{mdxType:"InlineNotification"},(0,t.yg)("p",null,"Newer versions of ",(0,t.yg)("inlineCode",{parentName:"p"},"kubectl")," add a ",(0,t.yg)("inlineCode",{parentName:"p"},"metadata.ownerReferences")," field to the output of ",(0,t.yg)("inlineCode",{parentName:"p"},"kubectl create job --from=..."),".\nThis field must be removed before creating the new jobs from these YAML files.")),(0,t.yg)("h3",null,"Running batch streaming yaml files"),(0,t.yg)("p",null,"To orchestrate the batch process, run the following command and repeat for the chunker and streamer."),(0,t.yg)("pre",null,(0,t.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl create -f stream_foodassistance.yaml -n $namespace\nkubectl create -f chunker_foodassistance.yaml -n $namespace\n")),(0,t.yg)("h3",null,"Post batch processing"),(0,t.yg)("p",null,"The batch pods that are created for batch streaming are on demand."),(0,t.yg)("p",null,"When the batch processes finish, the pods remain in a ",(0,t.yg)("inlineCode",{parentName:"p"},"completed")," state.\nWhile this does not consume CPU or Memory resources on the worker nodes of your cluster, this may place added pressure on the Kubernetes API server"),(0,t.yg)(c,{mdxType:"InlineNotification"},(0,t.yg)("p",null,"A ",(0,t.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/ttlafterfinished/"},"TTL Controller for Finished Resources")," is available in Kubernetes, which will automatically clean up any completed pods after a specified length of time.\nHowever, this feature is in Alpha state and has to be enabled using a feature flag on both the ",(0,t.yg)("inlineCode",{parentName:"p"},"kube-apiserver")," and ",(0,t.yg)("inlineCode",{parentName:"p"},"kube-controller-manager"),"."),(0,t.yg)("p",null,(0,t.yg)("strong",{parentName:"p"},"Note:")," It is not recommended to use Alpha features in a production environment.")))}f.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-supporting-infrastructure-batch-batch-streaming-mdx-78c2e1bd687f21cd300e.js.map